<!DOCTYPE html>
<html>
  <head>
    <title>Terrain Generator</title>
  </head>

<body>
<style>
  body {
    margin: 0;
    overflow: hidden;
  }
</style>
<canvas id="c"></canvas>
<script type="text/javascript" src="lib/dat.gui.min.js"></script>
<script type="text/javascript" src="lib/Terrain.js"></script>
<script type="text/javascript" src="lib/util.js"></script>

   <script id="3d-vertex-shader" type="notjs">
    // an attribute will receive data from a buffer
    attribute vec4 a_position;
    attribute vec3 a_normal;

    uniform mat4 u_worldViewProjection;
    uniform mat4 u_world;

    varying vec3 v_position;
    varying vec3 v_normal;
    varying float v_height;

    void main(){

    v_position = a_position.xyz;
    v_normal = mat3(u_world) * a_normal;
    v_height = a_position.y;

        gl_Position = u_worldViewProjection * a_position;

    }
  </script>

  <script id="3d-fragment-shader" type="notjs">
    // fragment shaders don't have a default precision so we need
    // to pick one. mediump is a good default

    precision mediump float;
    uniform vec3 u_light;

    varying vec3 v_position;
    varying vec3 v_normal;
    varying float v_height;

    float rand(vec2 co){
      return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
    }

    void main() {

    vec3 green = vec3(0.6,0.64,0.07);
    vec3 grey = vec3(0.3,0.3,0.3);
    vec3 white = vec3(1.,1.,1.);

        vec3 color = vec3(0,0,0);

        float gradientCenter = -2. + rand(v_normal.xy);
        float gradientAmplitude = 0.25 + rand(v_normal.zy);

        vec3 material_color = mix(
            green,
            grey,
            smoothstep(
              gradientCenter-gradientAmplitude,
              gradientCenter+gradientAmplitude,
              v_height/600.
            )
        );

        gradientCenter += 3.;

        material_color = mix(
          material_color,
          white,
          smoothstep(
            gradientCenter-gradientAmplitude,
            gradientCenter+gradientAmplitude,
            v_height/600.
          )
        );

        vec3 light_color = vec3(0.5,0.5,0.5);

        vec3 normal = normalize(v_normal);

        float diffuse = dot(normal, u_light);

        color = material_color + light_color*diffuse;

      float fogEnd = 10000.;
      float fogStart = 1.;

      float distance = distance(v_position,vec3(0.0,5000.0,8000.0));
      float fogFactor = exp((-distance*.0001));

      vec3 rayDir = normalize(v_position - normalize(vec3(0.,5000.,8000.)));

      float sunAmount = max( dot( rayDir, u_light ), 0.0 );

      vec3  fogColor  = mix( vec3(0.5,0.6,0.7), // bluish
                             vec3(1.0,0.9,0.7), // yellowish
                             pow(sunAmount,3.0) );

        color = mix(fogColor,color,fogFactor);

        gl_FragColor = vec4(color,1.0);
    }
  </script>
  <script src="index.js"></script>

</body>
  
</html>
